<form method="POST" action="<%= url %>"
    id="my_form">
    <div class="form-group">
        <div class="form-row">
            <div class="form-group col">
                <input type="text" class="form-control" id="s1f1" name="s1_f1" placeholder="<%= obj.s1.f1.caption %>"
                    value="<%= obj.s1.f1.value %>">
            </div>
            <div class="form-group col">
                <input type="text" class="form-control" id="s1f2" name="s1_f2" placeholder="<%= obj.s1.f2.caption %>"
                    value="<%= obj.s1.f2.value %>">
            </div>
            <div class="form-group col">
                <input type="text" class="form-control" id="s1f3" name="s1_f3" placeholder="<%= obj.s1.f3.caption %>"
                    value="<%= obj.s1.f3.value %>">
            </div>
        </div>
    </div>
    <hr class="sidebar-divider">
    <div class="form-group">
        <h8 class="m-0 font-weight-bold text-secondary"><%= obj.s2.caption %></h8>
        <div class="form-row">
            <div class="form-group col">
                <input type="text" class="form-control" name="s2_f1" id="s2f1" placeholder="<%= obj.s2.f1.caption %>"
                    value="<%= obj.s2.f1.value %>">
            </div>
            <div class="form-group col">
                <input type="text" class="form-control" name="s2_f2" id="s2f2" placeholder="<%= obj.s2.f2.caption %>"
                    value="<%= obj.s2.f2.value %>">
            </div>
            <div class="form-group col">
                <input type="text" class="form-control" name="s2_f3" id="s2f3" placeholder="<%= obj.s2.f3.caption %>"
                    value="<%= obj.s2.f3.value %>">
            </div>
            <div class="form-group col">
                <input type="text" class="form-control" name="s2_f4" id="s2f4" placeholder="<%= obj.s2.f4.caption %>"
                    value="<%= obj.s2.f4.value %>">
            </div>
        </div>
    </div>
    <div class="form-group">
        <div class="form-row">
            <div class="form-group col">
                <input type="text" class="form-control" name="s2_f5" id="s2f5" placeholder="<%= obj.s2.f5.caption %>"
                    value="<%= obj.s2.f5.value %>">
            </div>
            <div class="form-group col">
                <input type="text" class="form-control" name="s2_f6" id="s2f6" placeholder="<%= obj.s2.f6.caption %>"
                    value="<%= obj.s2.f6.value %>">
            </div>
            <div class="form-group col">
                <input type="text" class="form-control" name="s2_f7" id="s2f7" placeholder="<%= obj.s2.f7.caption %>"
                    value="<%= obj.s2.f7.value %>">
            </div>
            <div class="form-group col">
                <input type="text" class="form-control" name="s2_f8" id="s2f8" placeholder="<%= obj.s2.f8.caption %>"
                    value="<%= obj.s2.f8.value %>">
            </div>
        </div>
    </div>
    <div class="form-group">
        <div class="form-row">
            <div class="form-group col">
                <input type="text" class="form-control" name="s2_f9" id="s2f9" placeholder="<%= obj.s2.f9.caption %>"
                    value="<%= obj.s2.f9.value %>">
            </div>
            <div class="form-group col">
                <input type="text" class="form-control" name="s2_f10" id="s2f10" placeholder="<%= obj.s2.f10.caption %>"
                    value="<%= obj.s2.f10.value %>">
            </div>
            <div class="form-group col">
                <input type="text" class="form-control" name="s2_f11" id="s2f11" placeholder="<%= obj.s2.f11.caption %>"
                    value="<%= obj.s2.f11.value %>">
            </div>
        </div>
    </div>
    <div class="form-group">
        <div class="form-row">
            <div class="form-group col">
                <input type="text" class="form-control" name="s2_f12" id="s2f12" placeholder="<%= obj.s2.f12.caption %>"
                    value="<%= obj.s2.f12.value %>">
            </div>
            <div class="form-group col">
                <input type="text" class="form-control" name="s2_f13" id="s2f13" placeholder="<%= obj.s2.f13.caption %>"
                    value="<%= obj.s2.f13.value %>">
            </div>
        </div>
    </div>
    <hr class="sidebar-divider">
    <div class="form-group">
        <h8 class="m-0 font-weight-bold text-secondary"><%= obj.s3.caption %></h8>
        <div class="form-row">
            <div class="form-group col">
                <input type="text" class="form-control" name="s3_f1" id="s3f1" placeholder="<%= obj.s3.f1.caption %>"
                    value="<%= obj.s3.f1.value %>">
            </div>
            <div class="form-group col">
                <input type="text" class="form-control" name="s3_f2" id="s3f2" placeholder="<%= obj.s3.f2.caption %>"
                    value="<%= obj.s3.f2.value %>">
            </div>
            <div class="form-group col">
                <input type="text" class="form-control" name="s3_f3" id="s3f3" placeholder="<%= obj.s3.f3.caption %>"
                    value="<%= obj.s3.f3.value %>">
            </div>
        </div>
        <div class="form-group">
            <div class="form-row">
                <div class="form-group col">
                    <input type="text" class="form-control" name="s3_f4" id="s3f4"
                        placeholder="<%= obj.s3.f4.caption %>" value="<%= obj.s3.f4.value %>">
                </div>
                <div class="form-group col">
                    <input type="text" class="form-control" name="s3_f5" id="s3f5"
                        placeholder="<%= obj.s3.f5.caption %>" value="<%= obj.s3.f5.value %>">
                </div>
            </div>
        </div>
    <%if (obj.original == "0") { %>
    <div class="form-check">
        <input type="checkbox" class="form-check-input" name="original" id="original">

    <!-- <input type="checkbox" id="original" name="original"> -->
    <% } else { %>
    <div class="form-check">
        <input type="checkbox" class="form-check-input" name="original" id="original" checked>

        <!-- <input type="checkbox" id="original" name="original" checked> -->
        <% }%>

        <%if (obj.type == "English") { %>
        <label class="form-check-label" for="original">True Copy of the Original</label>
    </div>
    <!-- <label for="original">True Copy of the Original</label> -->
    <% } else if (obj.type == "Français") {%>
    <label class="form-check-label" for="original">Véritable copie de l'original</label>
    </div>
    <!-- <label for="original">Véritable copie de l'original</label> -->
    <% } else if (obj.type == "Español") {%>
    <label class="form-check-label" for="original">Copia verdadera del origina</label>
    </div>
    <!-- <label for="original">Copia verdadera del original</label> -->
    <% } else {%>
    <% }%>
        <br>
        <br>
        <div class="btn-group" role="group" aria-label="Basic example">
            <button type="submit" name="submit" class="btn btn-primary">Submit</button>
            <a href="" style="display: none;" name="download" id="download" class="btn btn-secondary">Download</a>
        </div>
</form>


<!-- <script src="paidscript.js"></script> -->

<script>
    $(document).ready(function () {

        // Retrieve form data from local storage
        var saved_data = localStorage.getItem("form_data");
        var saved_type = localStorage.getItem("form_type");
        var saved_language = localStorage.getItem("form_language");

        var urlString = "<%= url %>";
        var idString = urlString.substring(urlString.indexOf("id=") + 3);
        console.log(idString);

        var saved_user = localStorage.getItem("form_user");

        // Check if the saved data matches the specific type, language, and user
        if (saved_data && saved_type === "<%= obj.caption %>" && saved_language === "<%= obj.type %>" && saved_user === idString) {
            //$('#my_form').deserialize(saved_data);
            var formDataArray = saved_data.split("&");
            for (var i = 0; i < formDataArray.length; i++) {
                var fieldData = formDataArray[i].split("=");
                var fieldName = decodeURIComponent(fieldData[0]);
                var fieldValue = decodeURIComponent(fieldData[1]);
                $('#my_form [name="' + fieldName + '"]').val(fieldValue);
            }
        }
    });

    // Auto-save form data
    var autoSaveTimer;

    $("#my_form input, #my_form select, #my_form textarea").on("input", function () {
        clearTimeout(autoSaveTimer);
        autoSaveTimer = setTimeout(function () {
            saveFormData();
        }, 1000);
    });

    function saveFormData() {
        var form_data = $('#my_form').serialize();

        // Save form data and parameters to local storage
        localStorage.setItem("form_data", form_data);
        localStorage.setItem("form_type", "<%= obj.caption %>");
        localStorage.setItem("form_language", "<%= obj.type %>");

        var urlString = "<%= url %>";
        var idString = urlString.substring(urlString.indexOf("id=") + 3);

        localStorage.setItem("form_user", idString);
    }

    $("#my_form").submit(function (event) {
        event.preventDefault(); //prevent default action 

        clearTimeout(autoSaveTimer);
        saveFormData();
        var post_url = $(this).attr("action"); //get form action url
        var request_method = $(this).attr("method"); //get form GET/POST method
        var form_data = $(this).serialize(); //Encode form elements for submission

        $.ajax({
            url: post_url,
            type: request_method,
            data: form_data,
            success: function (result) {
                if(result == "error")
                {
                    toastr["error"]("Document not inserted", "Document Save error")
                    return;
                }

                toastr["success"]("Document successfully inserted", "Document saved")
                $("#download").show();
                $("#download").attr("href", result['link']);
                $('#paid').show();
                $('#paid').html(result['paid']);


                // Remove saved form data and parameters from local storage if the request matches
                var saved_type = localStorage.getItem("form_type");
                var saved_language = localStorage.getItem("form_language");
                var saved_user = localStorage.getItem("form_user");
                
                var urlString = "<%= url %>";
                var idString = urlString.substring(urlString.indexOf("id=") + 3);
                console.log(idString);

                if (saved_type === "<%= obj.caption %>" && saved_language === "<%= obj.type %>" && saved_user === idString) {
                    localStorage.removeItem("form_data");
                    localStorage.removeItem("form_type");
                    localStorage.removeItem("form_language");
                    localStorage.removeItem("form_user");
                }

            },
            error: function () {
                // Handle error and attempt to resend data
                toastr["error"]("Server not responding. Resending data when connection is reestablished.");

                // Retrieve form data from local storage
                var saved_data = localStorage.getItem("form_data");
                var saved_type = localStorage.getItem("form_type");
                var saved_language = localStorage.getItem("form_language");
                var saved_user = localStorage.getItem("form_user");

                var urlString = "<%= url %>";
                var idString = urlString.substring(urlString.indexOf("id=") + 3);
                console.log(idString);

                if (saved_data && saved_type === "<%= obj.caption %>" && saved_language === "<%= obj.type %>" && saved_user === idString) {
                    $.ajax({
                        url: post_url,
                        type: request_method,
                        data: saved_data,
                        success: function (result) {
                            if (result === "error") {
                                toastr["error"]("Document not inserted", "Document Save error");
                                return;
                            }

                            toastr["success"]("Document successfully inserted", "Document saved");
                            $("#download").show();
                            $("#download").attr("href", result['link']);
                            $('#paid').show();
                            $('#paid').html(result['paid']);
 
                            // Remove saved form data and parameters from local storage
                            localStorage.removeItem("form_data");
                            localStorage.removeItem("form_type");
                            localStorage.removeItem("form_language");
                            localStorage.removeItem("form_user");
                        },
                        error: function () {
                            toastr["error"]("Failed to resend data. Please try again later.");
                        }
                    });
                } else {
                    toastr["error"]("No saved form data found.");
                }
            }
        });
    });
</script>